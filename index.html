<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>NFC Terminál V2 (stabilní)</title>
<style>
  * { box-sizing: border-box; }
  body { 
    margin: 0; 
    font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, Arial, sans-serif; 
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
    background-attachment: fixed;
    color: #fff; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    min-height: 100vh; 
    padding: 40px 20px;
    position: relative;
  }
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 50%, rgba(0, 170, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(0, 170, 255, 0.05) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }
  h1 { 
    font-size: 42px; 
    font-weight: 700;
    margin-bottom: 40px; 
    background: linear-gradient(135deg, #00d4ff 0%, #0af 50%, #0088ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-align: center;
    letter-spacing: -0.5px;
    position: relative;
    z-index: 1;
    text-shadow: 0 0 40px rgba(0, 170, 255, 0.3);
  }
  .card { 
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(17, 17, 17, 0.9) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 170, 255, 0.2);
    border-radius: 24px; 
    padding: 32px; 
    margin-bottom: 28px; 
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 
                0 0 0 1px rgba(0, 170, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
    text-align: center;
    position: relative;
    z-index: 1;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 
                0 0 0 1px rgba(0, 170, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
  }
  #screen { 
    width: 380px; 
    max-width: 100%;
  }
  #screen > div:first-child {
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 600;
    margin-bottom: 8px;
  }
  #balance { 
    font-size: 48px; 
    font-weight: 700; 
    margin: 12px 0 20px 0; 
    background: linear-gradient(135deg, #00d4ff 0%, #0af 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -1px;
  }
  #status { 
    font-size: 15px; 
    color: rgba(255, 255, 255, 0.7); 
    min-height: 32px; 
    margin-top: 16px;
    padding: 8px 16px;
    border-radius: 12px;
    line-height: 1.4;
    font-weight: 500;
  }
  #status.info { 
    color: #0af;
    background: rgba(0, 170, 255, 0.1);
  }
  #status.success { 
    color: #2ecc71;
    background: rgba(46, 204, 113, 0.1);
  }
  #status.error { 
    color: #ff6b6b;
    background: rgba(255, 107, 107, 0.1);
  }
  #amountInput { 
    font-size: 32px; 
    font-weight: 600;
    text-align: center; 
    border: 2px solid rgba(0, 170, 255, 0.3); 
    border-radius: 16px; 
    padding: 16px 20px; 
    margin: 24px 0; 
    width: 100%; 
    max-width: 280px;
    background: rgba(0, 0, 0, 0.4);
    color: #0af;
    transition: all 0.3s;
    letter-spacing: 2px;
  }
  #amountInput:focus {
    outline: none;
    border-color: #0af;
    box-shadow: 0 0 0 4px rgba(0, 170, 255, 0.1);
  }
  #keypad { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 12px; 
    width: 100%;
    max-width: 300px; 
    margin: 0 auto 28px auto; 
  }
  .key { 
    background: linear-gradient(135deg, #00d4ff 0%, #0af 100%);
    color: #000; 
    font-size: 24px; 
    font-weight: 700; 
    padding: 20px; 
    border: none; 
    border-radius: 16px; 
    cursor: pointer; 
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
    box-shadow: 0 4px 12px rgba(0, 170, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
  }
  .key::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.2s;
  }
  .key:hover::before {
    opacity: 1;
  }
  .key:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 170, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
  }
  .key:active { 
    transform: scale(0.95) translateY(0); 
    box-shadow: 0 2px 8px rgba(0, 170, 255, 0.3);
  }
  #controls { 
    display: flex; 
    justify-content: center; 
    gap: 16px; 
    margin-top: 20px;
    flex-wrap: wrap;
  }
  button.action { 
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: #fff; 
    font-size: 17px; 
    font-weight: 700; 
    padding: 16px 32px; 
    border: none; 
    border-radius: 16px; 
    cursor: pointer; 
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
    box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  button.action::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.2s;
  }
  button.action:hover::before {
    opacity: 1;
  }
  button.action:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(46, 204, 113, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }
  button.action:active { 
    transform: scale(0.95) translateY(0); 
    box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
  }
  button.action:first-child {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }
  button.action:first-child:hover {
    box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }
  button.action:first-child:active {
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
  }
  #startNFC { 
    background: linear-gradient(135deg, #00d4ff 0%, #0af 100%);
    color: #000; 
    font-size: 18px; 
    font-weight: 700; 
    padding: 18px 40px; 
    border: none; 
    border-radius: 50px; 
    cursor: pointer; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    box-shadow: 0 6px 20px rgba(0, 170, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
    margin-top: 20px;
    position: relative;
    z-index: 1;
    text-transform: uppercase;
    letter-spacing: 1px;
    overflow: hidden;
  }
  #startNFC::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.2s;
  }
  #startNFC:hover::before {
    opacity: 1;
  }
  #startNFC:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 24px rgba(0, 170, 255, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
  }
  #startNFC:active { 
    transform: scale(0.95) translateY(0); 
    box-shadow: 0 3px 12px rgba(0, 170, 255, 0.4);
  }
  #startNFC[disabled] { 
    opacity: 0.4; 
    cursor: not-allowed; 
    box-shadow: none;
    transform: none;
  }
  #startNFC[disabled]::before {
    opacity: 0;
  }
  @media (max-width: 480px) {
    h1 { font-size: 32px; }
    #screen { width: 100%; }
    #balance { font-size: 40px; }
    #amountInput { font-size: 28px; }
    .card { padding: 24px; }
  }
</style>
</head>
<body>
<h1>NFC Terminál V2</h1>

<div class="card" id="screen">
  <div>Zůstatek:</div>
  <div id="balance">?</div>
  <input id="amountInput" type="text" readonly placeholder="0 Kč">
  <div id="status" class="info"></div>
</div>

<div class="card">
  <div id="keypad">
    <button class="key" onclick="pressKey('1')">1</button>
    <button class="key" onclick="pressKey('2')">2</button>
    <button class="key" onclick="pressKey('3')">3</button>
    <button class="key" onclick="pressKey('4')">4</button>
    <button class="key" onclick="pressKey('5')">5</button>
    <button class="key" onclick="pressKey('6')">6</button>
    <button class="key" onclick="pressKey('7')">7</button>
    <button class="key" onclick="pressKey('8')">8</button>
    <button class="key" onclick="pressKey('9')">9</button>
    <button class="key" onclick="clearInput()">C</button>
    <button class="key" onclick="pressKey('0')">0</button>
    <button class="key" onclick="backspace()">⌫</button>
  </div>
  <div id="controls">
    <button class="action" onclick="startPayment()">Zaplatit</button>
    <button class="action" onclick="startTopUp()">Dobít</button>
  </div>
</div>

<button id="startNFC">Zapnout NFC</button>

<script>
/* -------------------------
   Konfigurace / stav
   ------------------------- */
let ndef = null;
let balance = null;
let currency = "CZK";
let pendingAction = null; // "pay" | "topup"
let amount = 0;
let busy = false; // blokace během operace
const SECRET_KEY = "demo123"; // tajný klíč pro XOR (demo)
const DEFAULT_BALANCE = 20;

/* -------------------------
   UI pomocníci
   ------------------------- */
function setStatus(msg, type = "info") {
  const el = document.getElementById("status");
  el.textContent = msg;
  el.className = type;
}
function updateDisplay() {
  const balEl = document.getElementById("balance");
  balEl.textContent = (balance !== null ? balance : "?") + " " + currency;
}

/* -------------------------
   Base64 / XOR přes bajty
   ------------------------- */
function bytesToBase64(bytes) {
  let binary = "";
  const len = bytes.length;
  for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}
function base64ToBytes(b64) {
  const binary = atob(b64);
  const len = binary.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
  return bytes;
}
function xorBytes(dataBytes, keyStr) {
  const keyBytes = new TextEncoder().encode(keyStr);
  const out = new Uint8Array(dataBytes.length);
  for (let i = 0; i < dataBytes.length; i++) {
    out[i] = dataBytes[i] ^ keyBytes[i % keyBytes.length];
  }
  return out;
}

/* -------------------------
   NFC inicializace (po kliknutí)
   ------------------------- */
async function initNFC() {
  if (!("NDEFReader" in window)) {
    setStatus("NFC není podporováno v tomto prohlížeči.", "error");
    return;
  }
  ndef = new NDEFReader();
  try {
    await ndef.scan(); // Chrome vyžádá oprávnění uživatele
    setStatus("NFC aktivní — přiložte kartu...", "info");
    // Deaktivujeme tlačítko, aby uživatel přesně věděl, že je NFC zapnuté
    document.getElementById("startNFC").disabled = true;
    ndef.onreading = (event) => { handleReading(event); };
    ndef.onreadingerror = (e) => { setStatus("Chyba čtení NFC: " + e, "error"); };
  } catch (err) {
    setStatus("NFC zamítnuto nebo chyba: " + String(err), "error");
  }
}

/* -------------------------
   Zpracování čtení
   ------------------------- */
async function handleReading(event) {
  if (busy) return; // ignorujeme, dokud probíhá operace
  busy = true;
  try {
    let found = false;
    // prohlédneme záznamy
    for (const record of event.message.records) {
      // očekáváme, že uložený záznam je base64(XOR(payload))
      if (record.recordType === "mime" && record.mediaType === "application/json") {
        // record.data by měl být ArrayBuffer / Uint8Array
        let base64Str;
        try {
          base64Str = (record.data instanceof ArrayBuffer || ArrayBuffer.isView(record.data))
            ? new TextDecoder().decode(record.data)
            : String(record.data);
        } catch (_) {
          // fallback
          try { base64Str = String(record.data); } catch(e){}
        }
        if (!base64Str) continue;
        try {
          const bytes = base64ToBytes(base64Str);
          const decryptedBytes = xorBytes(bytes, SECRET_KEY);
          const jsonText = new TextDecoder().decode(decryptedBytes);
          const obj = JSON.parse(jsonText);
          if (obj.c && typeof obj.b === "number") {
            currency = obj.c;
            balance = obj.b;
            found = true;
            break; // našli jsme záznam, ukončíme cyklus
          }
        } catch (e) {
          // ignore malformed record
        }
      }
    }

    if (!found) {
      // karta prázdná → inicializuj na DEFAULT_BALANCE
      balance = DEFAULT_BALANCE;
      currency = "CZK";
      try {
        await writeCard(balance, currency);
        setStatus("Karta inicializována (" + DEFAULT_BALANCE + " Kč)", "success");
      } catch (e) {
        setStatus("Chyba při inicializaci karty: " + e, "error");
      }
    } else {
      setStatus("Karta načtena.", "info");
    }
    updateDisplay();

    // pokud jsme měli čekající akci (pay/topup), proveď ji
    if (pendingAction) {
      if (pendingAction === "pay") {
        if (balance >= amount) {
          balance -= amount;
          try {
            await writeCard(balance, currency);
            setStatus("Platba " + amount + " Kč proběhla.", "success");
          } catch (e) {
            setStatus("Chyba při ukládání po platbě: " + e, "error");
          }
        } else {
          setStatus("Nedostatek prostředků!", "error");
        }
      } else if (pendingAction === "topup") {
        balance += amount;
        try {
          await writeCard(balance, currency);
          setStatus("Dobito " + amount + " Kč.", "success");
        } catch (e) {
          setStatus("Chyba při ukládání po dobití: " + e, "error");
        }
      }
      updateDisplay();
      pendingAction = null;
      clearInput();
    }
  } finally {
    busy = false; // vždy uvolníme zámek
  }
}

/* -------------------------
   Zápis na kartu (Base64(XOR(bytes)))
   ------------------------- */
async function writeCard(bal, cur) {
  if (!ndef) throw new Error("NFC není inicializované");
  const payload = JSON.stringify({ c: cur, b: bal });
  const payloadBytes = new TextEncoder().encode(payload);
  const xored = xorBytes(payloadBytes, SECRET_KEY);
  const base64Str = bytesToBase64(xored);
  const bytesToWrite = new TextEncoder().encode(base64Str); // uložíme base64 ASCII
  try {
    await ndef.write({
      records: [{ recordType: "mime", mediaType: "application/json", data: bytesToWrite }]
    });
  } catch (err) {
    throw err;
  }
}

/* -------------------------
   Operace UI
   ------------------------- */
function getAmount() {
  const val = parseInt(document.getElementById("amountInput").value, 10);
  return isNaN(val) || val <= 0 ? null : val;
}

function startPayment() {
  const val = getAmount();
  if (!val) { setStatus("Zadejte částku!", "error"); return; }
  pendingAction = "pay";
  amount = val;
  setStatus("Přiložte kartu k zaplacení " + val + " Kč...", "info");
}

function startTopUp() {
  const val = getAmount();
  if (!val) { setStatus("Zadejte částku!", "error"); return; }
  pendingAction = "topup";
  amount = val;
  setStatus("Přiložte kartu k dobití " + val + " Kč...", "info");
}

/* -------------------------
   Keypad
   ------------------------- */
function pressKey(digit) {
  const input = document.getElementById("amountInput");
  input.value = (input.value === "0" || input.value === "") ? String(digit) : input.value + String(digit);
}
function clearInput() { document.getElementById("amountInput").value = ""; }
function backspace() {
  const input = document.getElementById("amountInput");
  input.value = input.value.slice(0, -1);
}

/* -------------------------
   Eventy
   ------------------------- */
document.getElementById("startNFC").addEventListener("click", async () => {
  await initNFC();
});

/* -------------------------
   Init UI
   ------------------------- */
setStatus("Stiskněte 'Zapnout NFC' pro povolení", "info");
updateDisplay();
</script>
</body>
</html>
