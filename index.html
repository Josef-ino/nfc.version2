<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>NFC Termin√°l V2 (stabiln√≠)</title>
<style>
  * { box-sizing: border-box; }
  body { 
    margin: 0; 
    font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, Arial, sans-serif; 
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
    background-attachment: fixed;
    color: #fff; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    min-height: 100vh; 
    padding: 40px 20px;
    position: relative;
  }
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 50%, rgba(0, 170, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(0, 170, 255, 0.05) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }
  h1 { 
    font-size: 42px; 
    font-weight: 700;
    margin-bottom: 40px; 
    background: linear-gradient(135deg, #00d4ff 0%, #0af 50%, #0088ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-align: center;
    letter-spacing: -0.5px;
    position: relative;
    z-index: 1;
    text-shadow: 0 0 40px rgba(0, 170, 255, 0.3);
  }
  .card { 
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(17, 17, 17, 0.9) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 170, 255, 0.2);
    border-radius: 24px; 
    padding: 32px; 
    margin-bottom: 28px; 
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 
                0 0 0 1px rgba(0, 170, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
    text-align: center;
    position: relative;
    z-index: 1;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 
                0 0 0 1px rgba(0, 170, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
  }
  #screen { 
    width: 380px; 
    max-width: 100%;
  }
  #screen > div:first-child {
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 600;
    margin-bottom: 8px;
  }
  #balance { 
    font-size: 48px; 
    font-weight: 700; 
    margin: 12px 0 20px 0; 
    background: linear-gradient(135deg, #00d4ff 0%, #0af 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -1px;
  }
  #status { 
    font-size: 15px; 
    color: rgba(255, 255, 255, 0.7); 
    min-height: 32px; 
    margin-top: 16px;
    padding: 8px 16px;
    border-radius: 12px;
    line-height: 1.4;
    font-weight: 500;
  }
  #status.info { 
    color: #0af;
    background: rgba(0, 170, 255, 0.1);
  }
  #status.success { 
    color: #2ecc71;
    background: rgba(46, 204, 113, 0.1);
  }
  #status.error { 
    color: #ff6b6b;
    background: rgba(255, 107, 107, 0.1);
  }
  #amountInput { 
    font-size: 32px; 
    font-weight: 600;
    text-align: center; 
    border: 2px solid rgba(0, 170, 255, 0.3); 
    border-radius: 16px; 
    padding: 16px 20px; 
    margin: 24px 0; 
    width: 100%; 
    max-width: 280px;
    background: rgba(0, 0, 0, 0.4);
    color: #0af;
    transition: all 0.3s;
    letter-spacing: 2px;
  }
  #amountInput:focus {
    outline: none;
    border-color: #0af;
    box-shadow: 0 0 0 4px rgba(0, 170, 255, 0.1);
  }
  #keypad { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 12px; 
    width: 100%;
    max-width: 300px; 
    margin: 0 auto 28px auto; 
  }
  .key { 
    background: linear-gradient(135deg, #00d4ff 0%, #0af 100%);
    color: #000; 
    font-size: 24px; 
    font-weight: 700; 
    padding: 20px; 
    border: none; 
    border-radius: 16px; 
    cursor: pointer; 
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
    box-shadow: 0 4px 12px rgba(0, 170, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
  }
  .key::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.2s;
  }
  .key:hover::before {
    opacity: 1;
  }
  .key:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 170, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
  }
  .key:active { 
    transform: scale(0.95) translateY(0); 
    box-shadow: 0 2px 8px rgba(0, 170, 255, 0.3);
  }
  #controls { 
    display: flex; 
    justify-content: center; 
    gap: 16px; 
    margin-top: 20px;
    flex-wrap: wrap;
  }
  button.action { 
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: #fff; 
    font-size: 17px; 
    font-weight: 700; 
    padding: 16px 32px; 
    border: none; 
    border-radius: 16px; 
    cursor: pointer; 
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
    box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  button.action::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.2s;
  }
  button.action:hover::before {
    opacity: 1;
  }
  button.action:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(46, 204, 113, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }
  button.action:active { 
    transform: scale(0.95) translateY(0); 
    box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
  }
  button.action:first-child {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }
  button.action:first-child:hover {
    box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }
  button.action:first-child:active {
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
  }
  #startNFC { 
    background: linear-gradient(135deg, #00d4ff 0%, #0af 100%);
    color: #000; 
    font-size: 18px; 
    font-weight: 700; 
    padding: 18px 40px; 
    border: none; 
    border-radius: 50px; 
    cursor: pointer; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    box-shadow: 0 6px 20px rgba(0, 170, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
    margin-top: 20px;
    position: relative;
    z-index: 1;
    text-transform: uppercase;
    letter-spacing: 1px;
    overflow: hidden;
  }
  #startNFC::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.2s;
  }
  #startNFC:hover::before {
    opacity: 1;
  }
  #startNFC:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 24px rgba(0, 170, 255, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
  }
  #startNFC:active { 
    transform: scale(0.95) translateY(0); 
    box-shadow: 0 3px 12px rgba(0, 170, 255, 0.4);
  }
  #startNFC[disabled] { 
    opacity: 0.4; 
    cursor: not-allowed; 
    box-shadow: none;
    transform: none;
  }
  #startNFC[disabled]::before {
    opacity: 0;
  }
  /* Theme toggle */
  #themeToggle {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 170, 255, 0.2);
    border: 1px solid rgba(0, 170, 255, 0.3);
    border-radius: 50px;
    padding: 10px 20px;
    color: #0af;
    font-size: 24px;
    cursor: pointer;
    z-index: 100;
    transition: all 0.3s;
  }
  #themeToggle:hover {
    background: rgba(0, 170, 255, 0.3);
    transform: scale(1.1);
  }
  /* Light theme */
  body.light {
    background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 50%, #f0f0f0 100%);
    color: #333;
  }
  body.light::before {
    background: radial-gradient(circle at 20% 50%, rgba(0, 170, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(0, 170, 255, 0.08) 0%, transparent 50%);
  }
  body.light h1 {
    background: linear-gradient(135deg, #0099cc 0%, #0077aa 50%, #0055aa 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  body.light .card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(240, 240, 240, 0.95) 100%);
    border: 1px solid rgba(0, 170, 255, 0.3);
    color: #333;
  }
  body.light #status { color: #666; }
  body.light #status.info { color: #0af; background: rgba(0, 170, 255, 0.15); }
  body.light #status.success { color: #27ae60; background: rgba(46, 204, 113, 0.15); }
  body.light #status.error { color: #c0392b; background: rgba(231, 76, 60, 0.15); }
  body.light #amountInput { background: rgba(255, 255, 255, 0.6); color: #0077aa; }
  body.light #themeToggle { background: rgba(0, 170, 255, 0.15); border-color: rgba(0, 170, 255, 0.4); }
  
  /* Loading animation */
  #loadingOverlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  #loadingOverlay.show { display: flex; }
  .loader {
    width: 80px;
    height: 80px;
    border: 8px solid rgba(0, 170, 255, 0.2);
    border-top-color: #0af;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .loader-text {
    position: absolute;
    margin-top: 120px;
    color: #0af;
    font-size: 18px;
    font-weight: 600;
  }
  
  /* Transaction history */
  #transactionHistory {
    max-width: 380px;
    width: 100%;
    margin-bottom: 28px;
  }
  #transactionHistory h3 {
    font-size: 18px;
    margin: 0 0 16px 0;
    color: rgba(255, 255, 255, 0.8);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
  }
  body.light #transactionHistory h3 { color: #555; }
  .transaction {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    margin-bottom: 8px;
    font-size: 14px;
  }
  body.light .transaction { background: rgba(0, 0, 0, 0.05); }
  .transaction-type {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 12px;
  }
  .transaction-pay { color: #ff6b6b; }
  .transaction-topup { color: #2ecc71; }
  .transaction-amount {
    font-weight: 700;
    font-size: 16px;
  }
  .transaction-time {
    color: rgba(255, 255, 255, 0.5);
    font-size: 11px;
  }
  body.light .transaction-time { color: rgba(0, 0, 0, 0.4); }
  
  /* Card lock status */
  #lockStatus {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 12px;
    padding: 8px 16px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
  }
  body.light #lockStatus { background: rgba(0, 0, 0, 0.05); }
  #lockStatus.locked { color: #ff6b6b; }
  #lockStatus.unlocked { color: #2ecc71; }
  #lockBtn {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: #fff;
    border: none;
    border-radius: 12px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 8px;
    transition: all 0.2s;
  }
  #lockBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
  }
  #lockBtn.unlock {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
  }
  #lockBtn.unlock:hover {
    box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
  }
  
  /* PIN modal */
  #pinModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 300;
    align-items: center;
    justify-content: center;
  }
  #pinModal.show { display: flex; }
  .pin-content {
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.98) 0%, rgba(17, 17, 17, 0.98) 100%);
    border: 1px solid rgba(0, 170, 255, 0.3);
    border-radius: 24px;
    padding: 32px;
    max-width: 350px;
    width: 90%;
    text-align: center;
  }
  body.light .pin-content {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(240, 240, 240, 0.98) 100%);
    color: #333;
  }
  #pinInput {
    font-size: 32px;
    text-align: center;
    letter-spacing: 8px;
    border: 2px solid rgba(0, 170, 255, 0.3);
    border-radius: 12px;
    padding: 16px;
    margin: 20px 0;
    width: 100%;
    background: rgba(0, 0, 0, 0.4);
    color: #0af;
    font-weight: 700;
  }
  body.light #pinInput {
    background: rgba(255, 255, 255, 0.6);
    color: #0077aa;
  }
  #pinKeypad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin: 20px 0;
  }
  #pinKeypad .key {
    font-size: 20px;
    padding: 16px;
  }
  .pin-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
  }
  .pin-buttons button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }
  .pin-buttons .confirm {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: #fff;
  }
  .pin-buttons .cancel {
    background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    color: #fff;
  }
  
  @media (max-width: 480px) {
    h1 { font-size: 32px; }
    #screen { width: 100%; }
    #balance { font-size: 40px; }
    #amountInput { font-size: 28px; }
    .card { padding: 24px; }
    #themeToggle { top: 10px; right: 10px; padding: 8px 16px; font-size: 20px; }
  }
</style>
</head>
<body>
<button id="themeToggle" onclick="toggleTheme()">üåô</button>

<!-- Loading overlay -->
<div id="loadingOverlay">
  <div>
    <div class="loader"></div>
    <div class="loader-text">ƒåten√≠ NFC...</div>
  </div>
</div>

<!-- PIN Modal -->
<div id="pinModal">
  <div class="pin-content">
    <h2 id="pinModalTitle">Zadejte PIN</h2>
    <input id="pinInput" type="password" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" readonly>
    <div id="pinKeypad">
      <button class="key" onclick="pinPressKey('1')">1</button>
      <button class="key" onclick="pinPressKey('2')">2</button>
      <button class="key" onclick="pinPressKey('3')">3</button>
      <button class="key" onclick="pinPressKey('4')">4</button>
      <button class="key" onclick="pinPressKey('5')">5</button>
      <button class="key" onclick="pinPressKey('6')">6</button>
      <button class="key" onclick="pinPressKey('7')">7</button>
      <button class="key" onclick="pinPressKey('8')">8</button>
      <button class="key" onclick="pinPressKey('9')">9</button>
      <button class="key" onclick="pinClear()">C</button>
      <button class="key" onclick="pinPressKey('0')">0</button>
      <button class="key" onclick="pinBackspace()">‚å´</button>
    </div>
    <div class="pin-buttons">
      <button class="cancel" onclick="closePinModal()">Zru≈°it</button>
      <button class="confirm" onclick="confirmPin()">Potvrdit</button>
    </div>
  </div>
</div>

<h1>NFC Termin√°l V2</h1>

<div class="card" id="screen">
  <div id="lockStatus" class="unlocked">üîì Karta odemƒçena</div>
  <div>Z≈Østatek:</div>
  <div id="balance">?</div>
  <input id="amountInput" type="text" readonly placeholder="0 Kƒç">
  <div id="status" class="info"></div>
  <button id="lockBtn" class="unlock" onclick="toggleCardLock()">üîí Zamknout kartu</button>
</div>

<!-- Transaction History -->
<div class="card" id="transactionHistory">
  <h3>üìú Historie transakc√≠</h3>
  <div id="transactionList"></div>
</div>

<div class="card">
  <div id="keypad">
    <button class="key" onclick="pressKey('1')">1</button>
    <button class="key" onclick="pressKey('2')">2</button>
    <button class="key" onclick="pressKey('3')">3</button>
    <button class="key" onclick="pressKey('4')">4</button>
    <button class="key" onclick="pressKey('5')">5</button>
    <button class="key" onclick="pressKey('6')">6</button>
    <button class="key" onclick="pressKey('7')">7</button>
    <button class="key" onclick="pressKey('8')">8</button>
    <button class="key" onclick="pressKey('9')">9</button>
    <button class="key" onclick="clearInput()">C</button>
    <button class="key" onclick="pressKey('0')">0</button>
    <button class="key" onclick="backspace()">‚å´</button>
  </div>
  <div id="controls">
    <button class="action" onclick="startPayment()">Zaplatit</button>
    <button class="action" onclick="startTopUp()">Dob√≠t</button>
  </div>
</div>

<button id="startNFC">Zapnout NFC</button>

<script>
/* -------------------------
   Konfigurace / stav
   ------------------------- */
let ndef = null;
let balance = null;
let currency = "CZK";
let pendingAction = null; // "pay" | "topup" | "lock" | "unlock"
let amount = 0;
let busy = false; // blokace bƒõhem operace
const SECRET_KEY = "demo123"; // tajn√Ω kl√≠ƒç pro XOR (demo)
const DEFAULT_BALANCE = 20;
let transactionHistory = []; // historie transakc√≠
let cardLocked = false; // stav z√°mku karty
let cardPin = null; // PIN karty (null = nen√≠ nastaven)
let currentTheme = "dark"; // current theme
let pendingPinAction = null; // "set" | "unlock"

/* -------------------------
   UI pomocn√≠ci
   ------------------------- */
function setStatus(msg, type = "info") {
  const el = document.getElementById("status");
  el.textContent = msg;
  el.className = type;
}
function updateDisplay() {
  const balEl = document.getElementById("balance");
  balEl.textContent = (balance !== null ? balance : "?") + " " + currency;
  updateLockDisplay();
}

function updateLockDisplay() {
  const lockStatus = document.getElementById("lockStatus");
  const lockBtn = document.getElementById("lockBtn");
  
  if (cardLocked) {
    lockStatus.textContent = "üîí Karta zamƒçena";
    lockStatus.className = "locked";
    lockBtn.textContent = "üîì Odemknout kartu";
    lockBtn.className = "unlock";
  } else {
    lockStatus.textContent = "üîì Karta odemƒçena";
    lockStatus.className = "unlocked";
    lockBtn.textContent = "üîí Zamknout kartu";
    lockBtn.className = "";
  }
}

function showLoading(show = true) {
  const overlay = document.getElementById("loadingOverlay");
  if (show) {
    overlay.classList.add("show");
  } else {
    overlay.classList.remove("show");
  }
}

function addTransaction(type, amount) {
  const transaction = {
    type: type, // "pay" or "topup"
    amount: amount,
    timestamp: new Date().getTime()
  };
  transactionHistory.unshift(transaction);
  if (transactionHistory.length > 5) {
    transactionHistory = transactionHistory.slice(0, 5);
  }
  updateTransactionDisplay();
  saveTransactionsToLocalStorage();
}

function updateTransactionDisplay() {
  const listEl = document.getElementById("transactionList");
  if (transactionHistory.length === 0) {
    listEl.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px;">≈Ω√°dn√© transakce</div>';
    return;
  }
  
  listEl.innerHTML = transactionHistory.map(t => {
    const date = new Date(t.timestamp);
    const timeStr = date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
    const typeClass = t.type === "pay" ? "transaction-pay" : "transaction-topup";
    const typeText = t.type === "pay" ? "Platba" : "Dobit√≠";
    const sign = t.type === "pay" ? "-" : "+";
    
    return `
      <div class="transaction">
        <div>
          <div class="transaction-type ${typeClass}">${typeText}</div>
          <div class="transaction-time">${timeStr}</div>
        </div>
        <div class="transaction-amount ${typeClass}">${sign}${t.amount} Kƒç</div>
      </div>
    `;
  }).join('');
}

function saveTransactionsToLocalStorage() {
  try {
    localStorage.setItem('nfc_transactions', JSON.stringify(transactionHistory));
  } catch (e) {
    console.error('Failed to save transactions:', e);
  }
}

function loadTransactionsFromLocalStorage() {
  try {
    const saved = localStorage.getItem('nfc_transactions');
    if (saved) {
      transactionHistory = JSON.parse(saved);
      updateTransactionDisplay();
    }
  } catch (e) {
    console.error('Failed to load transactions:', e);
  }
}

/* -------------------------
   Theme toggle
   ------------------------- */
function toggleTheme() {
  const body = document.body;
  const toggle = document.getElementById("themeToggle");
  
  if (currentTheme === "dark") {
    body.classList.add("light");
    toggle.textContent = "‚òÄÔ∏è";
    currentTheme = "light";
  } else {
    body.classList.remove("light");
    toggle.textContent = "üåô";
    currentTheme = "dark";
  }
  
  try {
    localStorage.setItem('nfc_theme', currentTheme);
  } catch (e) {
    console.error('Failed to save theme:', e);
  }
}

function loadTheme() {
  try {
    const saved = localStorage.getItem('nfc_theme');
    if (saved === 'light') {
      toggleTheme();
    }
  } catch (e) {
    console.error('Failed to load theme:', e);
  }
}

/* -------------------------
   PIN Modal
   ------------------------- */
function showPinModal(title, action) {
  document.getElementById("pinModalTitle").textContent = title;
  document.getElementById("pinInput").value = "";
  document.getElementById("pinModal").classList.add("show");
  pendingPinAction = action;
}

function closePinModal() {
  document.getElementById("pinModal").classList.remove("show");
  document.getElementById("pinInput").value = "";
  pendingPinAction = null;
}

function pinPressKey(digit) {
  const input = document.getElementById("pinInput");
  if (input.value.length < 4) {
    input.value += digit;
  }
}

function pinClear() {
  document.getElementById("pinInput").value = "";
}

function pinBackspace() {
  const input = document.getElementById("pinInput");
  input.value = input.value.slice(0, -1);
}

function confirmPin() {
  const pin = document.getElementById("pinInput").value;
  if (pin.length !== 4) {
    setStatus("PIN mus√≠ m√≠t 4 ƒç√≠slice!", "error");
    return;
  }
  
  if (pendingPinAction === "set") {
    // Setting new PIN
    cardPin = pin;
    cardLocked = true;
    closePinModal();
    setStatus("Karta zamƒçena s PIN k√≥dem", "success");
    updateLockDisplay();
    
    // If we have a card, write the lock status
    if (ndef && balance !== null) {
      pendingAction = "lock";
      setStatus("P≈ôilo≈æte kartu k zaps√°n√≠ z√°mku...", "info");
    }
  } else if (pendingPinAction === "unlock") {
    // Unlocking card
    if (pin === cardPin) {
      cardLocked = false;
      closePinModal();
      setStatus("Karta odemƒçena!", "success");
      updateLockDisplay();
      
      // If we have a card, write the unlock status
      if (ndef && balance !== null) {
        pendingAction = "unlock";
        setStatus("P≈ôilo≈æte kartu k zaps√°n√≠ odemƒçen√≠...", "info");
      }
    } else {
      setStatus("Nespr√°vn√Ω PIN!", "error");
      pinClear();
    }
  }
}

function toggleCardLock() {
  if (cardLocked) {
    // Unlock - ask for PIN
    if (cardPin) {
      showPinModal("Odemknout kartu - Zadejte PIN", "unlock");
    } else {
      setStatus("Karta nem√° nastaven√Ω PIN!", "error");
    }
  } else {
    // Lock - set PIN
    showPinModal("Zamknout kartu - Nastavte PIN", "set");
  }
}

/* -------------------------
   Base64 / XOR p≈ôes bajty
   ------------------------- */
function bytesToBase64(bytes) {
  let binary = "";
  const len = bytes.length;
  for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}
function base64ToBytes(b64) {
  const binary = atob(b64);
  const len = binary.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
  return bytes;
}
function xorBytes(dataBytes, keyStr) {
  const keyBytes = new TextEncoder().encode(keyStr);
  const out = new Uint8Array(dataBytes.length);
  for (let i = 0; i < dataBytes.length; i++) {
    out[i] = dataBytes[i] ^ keyBytes[i % keyBytes.length];
  }
  return out;
}

/* -------------------------
   NFC inicializace (po kliknut√≠)
   ------------------------- */
async function initNFC() {
  if (!("NDEFReader" in window)) {
    setStatus("NFC nen√≠ podporov√°no v tomto prohl√≠≈æeƒçi.", "error");
    return;
  }
  ndef = new NDEFReader();
  try {
    await ndef.scan(); // Chrome vy≈æ√°d√° opr√°vnƒõn√≠ u≈æivatele
    setStatus("NFC aktivn√≠ ‚Äî p≈ôilo≈æte kartu...", "info");
    // Deaktivujeme tlaƒç√≠tko, aby u≈æivatel p≈ôesnƒõ vƒõdƒõl, ≈æe je NFC zapnut√©
    document.getElementById("startNFC").disabled = true;
    ndef.onreading = (event) => { handleReading(event); };
    ndef.onreadingerror = (e) => { setStatus("Chyba ƒçten√≠ NFC: " + e, "error"); };
  } catch (err) {
    setStatus("NFC zam√≠tnuto nebo chyba: " + String(err), "error");
  }
}

/* -------------------------
   Zpracov√°n√≠ ƒçten√≠
   ------------------------- */
async function handleReading(event) {
  if (busy) return; // ignorujeme, dokud prob√≠h√° operace
  busy = true;
  showLoading(true);
  
  try {
    let found = false;
    // prohl√©dneme z√°znamy
    for (const record of event.message.records) {
      // oƒçek√°v√°me, ≈æe ulo≈æen√Ω z√°znam je base64(XOR(payload))
      if (record.recordType === "mime" && record.mediaType === "application/json") {
        // record.data by mƒõl b√Ωt ArrayBuffer / Uint8Array
        let base64Str;
        try {
          base64Str = (record.data instanceof ArrayBuffer || ArrayBuffer.isView(record.data))
            ? new TextDecoder().decode(record.data)
            : String(record.data);
        } catch (_) {
          // fallback
          try { base64Str = String(record.data); } catch(e){}
        }
        if (!base64Str) continue;
        try {
          const bytes = base64ToBytes(base64Str);
          const decryptedBytes = xorBytes(bytes, SECRET_KEY);
          const jsonText = new TextDecoder().decode(decryptedBytes);
          const obj = JSON.parse(jsonText);
          if (obj.c && typeof obj.b === "number") {
            currency = obj.c;
            balance = obj.b;
            // Load lock status and PIN from card
            cardLocked = obj.locked === true;
            cardPin = obj.pin || null;
            found = true;
            break; // na≈°li jsme z√°znam, ukonƒç√≠me cyklus
          }
        } catch (e) {
          // ignore malformed record
        }
      }
    }

    if (!found) {
      // karta pr√°zdn√° ‚Üí inicializuj na DEFAULT_BALANCE
      balance = DEFAULT_BALANCE;
      currency = "CZK";
      cardLocked = false;
      cardPin = null;
      try {
        await writeCard(balance, currency, cardLocked, cardPin);
        setStatus("Karta inicializov√°na (" + DEFAULT_BALANCE + " Kƒç)", "success");
      } catch (e) {
        setStatus("Chyba p≈ôi inicializaci karty: " + e, "error");
      }
    } else {
      setStatus("Karta naƒçtena.", "info");
    }
    updateDisplay();

    // pokud jsme mƒõli ƒçekaj√≠c√≠ akci (pay/topup/lock/unlock), proveƒè ji
    if (pendingAction) {
      if (pendingAction === "pay") {
        if (cardLocked) {
          setStatus("Karta je zamƒçena! Odemknƒõte ji nejprve.", "error");
        } else if (balance >= amount) {
          balance -= amount;
          try {
            await writeCard(balance, currency, cardLocked, cardPin);
            setStatus("Platba " + amount + " Kƒç probƒõhla.", "success");
            addTransaction("pay", amount);
          } catch (e) {
            setStatus("Chyba p≈ôi ukl√°d√°n√≠ po platbƒõ: " + e, "error");
          }
        } else {
          setStatus("Nedostatek prost≈ôedk≈Ø!", "error");
        }
      } else if (pendingAction === "topup") {
        if (cardLocked) {
          setStatus("Karta je zamƒçena! Odemknƒõte ji nejprve.", "error");
        } else {
          balance += amount;
          try {
            await writeCard(balance, currency, cardLocked, cardPin);
            setStatus("Dobito " + amount + " Kƒç.", "success");
            addTransaction("topup", amount);
          } catch (e) {
            setStatus("Chyba p≈ôi ukl√°d√°n√≠ po dobit√≠: " + e, "error");
          }
        }
      } else if (pendingAction === "lock" || pendingAction === "unlock") {
        try {
          await writeCard(balance, currency, cardLocked, cardPin);
          setStatus(cardLocked ? "Karta zamƒçena." : "Karta odemƒçena.", "success");
        } catch (e) {
          setStatus("Chyba p≈ôi z√°pisu z√°mku: " + e, "error");
        }
      }
      updateDisplay();
      pendingAction = null;
      clearInput();
    }
  } finally {
    busy = false; // v≈ædy uvoln√≠me z√°mek
    showLoading(false);
  }
}

/* -------------------------
   Z√°pis na kartu (Base64(XOR(bytes)))
   ------------------------- */
async function writeCard(bal, cur, locked, pin) {
  if (!ndef) throw new Error("NFC nen√≠ inicializovan√©");
  const payload = JSON.stringify({ c: cur, b: bal, locked: locked, pin: pin });
  const payloadBytes = new TextEncoder().encode(payload);
  const xored = xorBytes(payloadBytes, SECRET_KEY);
  const base64Str = bytesToBase64(xored);
  const bytesToWrite = new TextEncoder().encode(base64Str); // ulo≈æ√≠me base64 ASCII
  try {
    await ndef.write({
      records: [{ recordType: "mime", mediaType: "application/json", data: bytesToWrite }]
    });
  } catch (err) {
    throw err;
  }
}

/* -------------------------
   Operace UI
   ------------------------- */
function getAmount() {
  const val = parseInt(document.getElementById("amountInput").value, 10);
  return isNaN(val) || val <= 0 ? null : val;
}

function startPayment() {
  const val = getAmount();
  if (!val) { setStatus("Zadejte ƒç√°stku!", "error"); return; }
  pendingAction = "pay";
  amount = val;
  setStatus("P≈ôilo≈æte kartu k zaplacen√≠ " + val + " Kƒç...", "info");
}

function startTopUp() {
  const val = getAmount();
  if (!val) { setStatus("Zadejte ƒç√°stku!", "error"); return; }
  pendingAction = "topup";
  amount = val;
  setStatus("P≈ôilo≈æte kartu k dobit√≠ " + val + " Kƒç...", "info");
}

/* -------------------------
   Keypad
   ------------------------- */
function pressKey(digit) {
  const input = document.getElementById("amountInput");
  input.value = (input.value === "0" || input.value === "") ? String(digit) : input.value + String(digit);
}
function clearInput() { document.getElementById("amountInput").value = ""; }
function backspace() {
  const input = document.getElementById("amountInput");
  input.value = input.value.slice(0, -1);
}

/* -------------------------
   Eventy
   ------------------------- */
document.getElementById("startNFC").addEventListener("click", async () => {
  await initNFC();
});

/* -------------------------
   Init UI
   ------------------------- */
setStatus("Stisknƒõte 'Zapnout NFC' pro povolen√≠", "info");
updateDisplay();
updateTransactionDisplay();
loadTransactionsFromLocalStorage();
loadTheme();
</script>
</body>
</html>
